// Không phải file để import đâu nha đừng dùng nó để import vô XAMPP

-- ================== Bảng roles ==================
CREATE TABLE roles (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID quyền, tự tăng',
    name VARCHAR(50) NOT NULL UNIQUE COMMENT 'Tên quyền: ADMIN, STAFF,...'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Bảng lưu các quyền người dùng';

-- ================== Bảng users ==================
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID người dùng, tự tăng',
    
    username VARCHAR(150) NOT NULL UNIQUE COMMENT 'Tên đăng nhập, duy nhất',
    password_hash VARCHAR(255) NOT NULL COMMENT 'Mật khẩu đã hash (BCrypt)',
    
    fullName VARCHAR(255) DEFAULT NULL COMMENT 'Họ và tên đầy đủ',
    dateOfBirth DATE DEFAULT NULL COMMENT 'Ngày sinh',
    email VARCHAR(255) UNIQUE COMMENT 'Email liên hệ, duy nhất',
    phone VARCHAR(50) UNIQUE COMMENT 'Số điện thoại, duy nhất',
    identityNumber VARCHAR(50) DEFAULT NULL COMMENT 'Căn cước công dân / CMND',
    address VARCHAR(255) DEFAULT NULL COMMENT 'Địa chỉ cư trú',
    gender TINYINT DEFAULT 0 COMMENT 'Giới tính: 0=Nam, 1=Nữ',
    
    role_id BIGINT NOT NULL COMMENT 'Khóa ngoại tới bảng roles',
    active TINYINT DEFAULT 1 COMMENT 'Trạng thái hoạt động: 1=active, 0=nghỉ việc',
    locked TINYINT DEFAULT 0 COMMENT 'Tài khoản khóa: 1=khóa, 0=mở',

    createdAt DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'Thời điểm tạo tài khoản',
    updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Thời điểm cập nhật gần nhất',
    lastLogin DATETIME DEFAULT NULL COMMENT 'Lần đăng nhập cuối cùng',

    refresh_token_hash VARCHAR(512) DEFAULT NULL COMMENT 'Hash refresh token',
    refreshTokenExpiry DATETIME DEFAULT NULL COMMENT 'Hết hạn refresh token',
    
    reset_password_token_hash VARCHAR(512) DEFAULT NULL COMMENT 'Hash token quên mật khẩu',
    resetPasswordTokenExpiry DATETIME DEFAULT NULL COMMENT 'Hết hạn token quên mật khẩu',

    CONSTRAINT fk_users_role FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Bảng lưu thông tin người dùng';

-- ================== Bảng customers ==================
CREATE TABLE customers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID khách hàng, tự tăng',

    fullName VARCHAR(150) NOT NULL COMMENT 'Họ và tên khách hàng',
    dateOfBirth DATE DEFAULT NULL COMMENT 'Ngày sinh',
    
    email VARCHAR(255) UNIQUE COMMENT 'Email liên hệ (duy nhất)',
    phone VARCHAR(50) UNIQUE COMMENT 'Số điện thoại (duy nhất)',
    
    address VARCHAR(500) DEFAULT NULL COMMENT 'Địa chỉ đầy đủ',
    identityNumber VARCHAR(50) DEFAULT NULL COMMENT 'Căn cước / CMND',
    gender TINYINT DEFAULT 0 COMMENT 'Giới tính: 0=Nam, 1=Nữ',

    tier VARCHAR(20) DEFAULT 'REGULAR' COMMENT 'Hạng khách: REGULAR, VIP, PREMIUM',
    points INT DEFAULT 0 COMMENT 'Điểm tích lũy của khách hàng',

    createdAt DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'Thời điểm thêm khách hàng',
    updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Thời điểm cập nhật gần nhất'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Bảng lưu thông tin khách hàng cửa hàng';

-- ================== Bảng units ==================
CREATE TABLE units (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID đơn vị, tự tăng',
    name VARCHAR(50) NOT NULL UNIQUE COMMENT 'Tên đơn vị: hộp, chiếc, cái…',
    description VARCHAR(255) DEFAULT NULL COMMENT 'Mô tả đơn vị (tùy chọn)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'Thời điểm tạo',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Thời điểm cập nhật'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Bảng lưu các đơn vị sản phẩm';


-- ================== Bảng suppliers  ==================
CREATE TABLE suppliers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID nhà cung cấp, tự tăng',
    name VARCHAR(150) NOT NULL COMMENT 'Tên nhà cung cấp',
    email VARCHAR(255) UNIQUE DEFAULT NULL COMMENT 'Email liên hệ',
    phone VARCHAR(50) UNIQUE DEFAULT NULL COMMENT 'Số điện thoại liên hệ',
    address VARCHAR(500) DEFAULT NULL COMMENT 'Địa chỉ nhà cung cấp',
    note VARCHAR(500) DEFAULT NULL COMMENT 'Ghi chú thêm',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'Thời điểm tạo',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Thời điểm cập nhật'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Bảng lưu thông tin nhà cung cấp';


-- ================== Bảng categories ==================
CREATE TABLE categories (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID danh mục, tự tăng',
    name VARCHAR(100) NOT NULL UNIQUE COMMENT 'Tên danh mục, duy nhất',
    description VARCHAR(255) DEFAULT NULL COMMENT 'Mô tả danh mục (tùy chọn)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'Thời điểm tạo',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Thời điểm cập nhật'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Bảng lưu các danh mục sản phẩm';

-- ================== Bảng products ==================
CREATE TABLE products (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID sản phẩm, tự tăng',

    sku VARCHAR(100) UNIQUE COMMENT 'Mã sản phẩm, duy nhất (SKU)',

    product_name VARCHAR(255) NOT NULL COMMENT 'Tên sản phẩm',

    category_id BIGINT DEFAULT NULL COMMENT 'Khóa ngoại tham chiếu bảng categories',
    supplier_id BIGINT DEFAULT NULL COMMENT 'Khóa ngoại tham chiếu bảng suppliers',
    unit_id BIGINT DEFAULT NULL COMMENT 'Khóa ngoại tham chiếu bảng units',

    price DECIMAL(12,2) NOT NULL DEFAULT 0 COMMENT 'Giá bán sản phẩm',
    cost DECIMAL(12,2) DEFAULT NULL COMMENT 'Giá nhập/cost của sản phẩm',

    description VARCHAR(500) DEFAULT NULL COMMENT 'Mô tả sản phẩm',
    image_url VARCHAR(1024) DEFAULT NULL COMMENT 'URL ảnh sản phẩm',

    is_active TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'Trạng thái sản phẩm: 1=hoạt động, 0=ngừng bán',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'Thời điểm tạo sản phẩm',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Thời điểm cập nhật sản phẩm',

    -- ================== Ràng buộc FK ==================
    CONSTRAINT fk_products_category FOREIGN KEY (category_id) REFERENCES categories(id),
    CONSTRAINT fk_products_supplier FOREIGN KEY (supplier_id) REFERENCES suppliers(id),
    CONSTRAINT fk_products_unit FOREIGN KEY (unit_id) REFERENCES units(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Bảng lưu thông tin sản phẩm của cửa hàng';

-- ================== Index ==================
CREATE INDEX idx_products_category ON products(category_id);
CREATE INDEX idx_products_supplier ON products(supplier_id);

-- ================== Bảng inventory ==================
CREATE TABLE inventory (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID inventory, tự tăng',

    product_id BIGINT NOT NULL COMMENT 'Khóa ngoại liên kết với bảng products (1 product ↔ 1 inventory)',

    quantity INT NOT NULL DEFAULT 0 COMMENT 'Số lượng hiện tại của sản phẩm',

    last_checked_at DATETIME DEFAULT NULL COMMENT 'Lần kiểm tra tồn kho gần nhất',

    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Thời điểm cập nhật inventory',

    -- ================== Ràng buộc FK ==================
    CONSTRAINT fk_inventory_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Bảng lưu tồn kho của từng sản phẩm';

-- ================== Index ==================
CREATE UNIQUE INDEX ux_inventory_product ON inventory(product_id);

-- ================== Bảng orders ==================
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID đơn hàng, tự tăng',
    
    order_number VARCHAR(100) NOT NULL UNIQUE COMMENT 'Mã đơn hàng, duy nhất',
    
    customer_id BIGINT DEFAULT NULL COMMENT 'Khóa ngoại tham chiếu Customer',
    staff_id BIGINT DEFAULT NULL COMMENT 'Khóa ngoại tham chiếu User (nhân viên bán)',
    
    status VARCHAR(50) DEFAULT 'pending' COMMENT 'Trạng thái đơn hàng: pending, paid, shipped...',
    
    subtotal DECIMAL(12,2) NOT NULL DEFAULT 0 COMMENT 'Tổng tiền trước giảm giá',
    discount DECIMAL(12,2) NOT NULL DEFAULT 0 COMMENT 'Giảm giá',
    total_amount DECIMAL(12,2) NOT NULL DEFAULT 0 COMMENT 'Tổng tiền thanh toán',
    
    promotion_id BIGINT DEFAULT NULL COMMENT 'Khuyến mãi áp dụng (nếu có)',
    
    note VARCHAR(500) DEFAULT NULL COMMENT 'Ghi chú đơn hàng',
    shipping_address VARCHAR(500) DEFAULT NULL COMMENT 'Địa chỉ giao hàng',
    
    is_online TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'Đơn online hay bán tại cửa hàng (1=online, 0=offline)',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'Soft delete: 0 = chưa xóa, 1 = đã xóa',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'Thời điểm tạo đơn hàng',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Thời điểm cập nhật đơn hàng',
    
    CONSTRAINT fk_orders_customer FOREIGN KEY (customer_id) REFERENCES customer(id),
    CONSTRAINT fk_orders_staff FOREIGN KEY (staff_id) REFERENCES users(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Bảng lưu đơn hàng';

-- Index
CREATE INDEX idx_orders_customer ON orders(customer_id);
CREATE INDEX idx_orders_staff ON orders(staff_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_is_deleted ON orders(is_deleted);


-- ================== Bảng payments ==================
CREATE TABLE payments (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID thanh toán, tự tăng',
    
    order_id BIGINT NOT NULL COMMENT 'Khóa ngoại liên kết với đơn hàng (1 order ↔ 1 payment)',
    
    amount DECIMAL(12,2) NOT NULL DEFAULT 0 COMMENT 'Số tiền thanh toán',
    method VARCHAR(50) NOT NULL DEFAULT 'cash' COMMENT 'Hình thức thanh toán: cash, card, momo...',
    transaction_ref VARCHAR(255) DEFAULT NULL COMMENT 'Mã giao dịch (nếu có)',
    status VARCHAR(50) NOT NULL DEFAULT 'completed' COMMENT 'Trạng thái thanh toán: completed, pending, failed',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'Thời điểm thanh toán',
    
    CONSTRAINT fk_payments_order FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Bảng lưu thanh toán của từng đơn hàng';

-- Index
CREATE UNIQUE INDEX idx_payments_order ON payments(order_id);

-- ================== Bảng order_items ==================

CREATE TABLE order_items (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID dòng sản phẩm trong order, tự tăng',

    order_id BIGINT NOT NULL COMMENT 'Khóa ngoại tham chiếu order',
    product_id BIGINT NOT NULL COMMENT 'Khóa ngoại tham chiếu product',

    quantity INT NOT NULL DEFAULT 1 COMMENT 'Số lượng sản phẩm',
    unit_price DECIMAL(12,2) NOT NULL DEFAULT 0 COMMENT 'Giá 1 sản phẩm khi bán',
    total_price DECIMAL(12,2) NOT NULL DEFAULT 0 COMMENT 'Tổng tiền = quantity * unit_price',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'Thời điểm tạo dòng order item',

    CONSTRAINT fk_orderitem_order FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    CONSTRAINT fk_orderitem_product FOREIGN KEY (product_id) REFERENCES products(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Chi tiết sản phẩm trong từng đơn hàng';

-- Index
CREATE INDEX idx_oi_order ON order_items(order_id);
CREATE INDEX idx_oi_product ON order_items(product_id);

-- ================== Bảng imports ==================
CREATE TABLE imports (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID phiếu nhập, tự tăng',
    
    import_number VARCHAR(100) NOT NULL UNIQUE COMMENT 'Mã phiếu nhập, duy nhất',
    
    supplier_id BIGINT NOT NULL COMMENT 'Khóa ngoại tham chiếu nhà cung cấp',
    staff_id BIGINT NOT NULL COMMENT 'Khóa ngoại tham chiếu nhân viên nhập hàng',
    
    total_amount DECIMAL(12,2) NOT NULL DEFAULT 0 COMMENT 'Tổng tiền phiếu nhập',
    
    note VARCHAR(500) DEFAULT NULL COMMENT 'Ghi chú phiếu nhập',

    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'Soft delete: 0 = chưa xóa, 1 = đã xóa',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'Thời điểm tạo phiếu nhập',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Thời điểm cập nhật phiếu nhập',
    
    CONSTRAINT fk_import_supplier FOREIGN KEY (supplier_id) REFERENCES suppliers(id),
    CONSTRAINT fk_import_staff FOREIGN KEY (staff_id) REFERENCES users(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Bảng phiếu nhập hàng';

-- Index
CREATE INDEX idx_imports_supplier ON imports(supplier_id);
CREATE INDEX idx_imports_staff ON imports(staff_id);
CREATE INDEX idx_imports_is_deleted ON imports(is_deleted);


-- ================== Bảng import_items ==================
CREATE TABLE import_items (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID chi tiết nhập',
    
    import_id BIGINT NOT NULL COMMENT 'Khóa ngoại liên kết với phiếu nhập',
    product_id BIGINT NOT NULL COMMENT 'Khóa ngoại liên kết với sản phẩm',
    
    quantity INT NOT NULL DEFAULT 1 COMMENT 'Số lượng nhập',
    unit_price DECIMAL(12,2) NOT NULL DEFAULT 0 COMMENT 'Giá nhập 1 sản phẩm',
    total_price DECIMAL(12,2) NOT NULL DEFAULT 0 COMMENT 'Tổng tiền = quantity * unit_price',
    
    CONSTRAINT fk_import_item_import FOREIGN KEY (import_id) REFERENCES imports(id) ON DELETE CASCADE,
    CONSTRAINT fk_import_item_product FOREIGN KEY (product_id) REFERENCES products(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Chi tiết sản phẩm trong phiếu nhập';

-- Index
CREATE INDEX idx_import_item_import ON import_items(import_id);
CREATE INDEX idx_import_item_product ON import_items(product_id);
